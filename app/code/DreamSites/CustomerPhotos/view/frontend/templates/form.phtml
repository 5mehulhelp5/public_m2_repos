<?php
/**
 * @var \DreamSites\CustomerPhotos\Block\Form $block
 */
?>
<div class="customer-photo-form">
    <?= $block->getMessagesBlock()->toHtml() ?>

    <p class="my-4">Add a photo of yourself modelling our clothing to appear on our homepage!</p>

    <form class="form customer-photo"
          action="<?= $block->escapeUrl($block->getFormAction()) ?>"
          method="post"
          id="customer-photo-form"
          @submit="validateForm($event)">

        <fieldset class="fieldset">
            <div class="field customer-name required">
                <label class="label" for="customer_name">
                    <span><?= $block->escapeHtml(__('Customer Name')) ?></span>
                </label>
                <div class="control">
                    <input type="text"
                           name="customer_name"
                           id="customer_name"
                           title="<?= $block->escapeHtmlAttr(__('Customer Name')) ?>"
                           class="input-text"
                           ref="customerName"
                           @input="validateCustomerName($event)"
                           value=""/>
                    <div v-show="errors.customerName" class="mage-error" id="customer_name-error">
                        <?= $block->escapeHtml(__('This is a required field.')) ?>
                    </div>
                </div>
            </div>

            <div class="field image-filename required">
                <label class="label" for="image_filename">
                    <span><?= $block->escapeHtml(__('Upload photo')) ?></span>
                </label>
                <div class="control">
                    <div id="image-upload-app">
                        <file-pond-uploader
                            :post_url="postUrl"
                            v-on:processfiles="handleFilesProcessed"
                            >
                        </file-pond-uploader>
                    </div>
                    <div v-show="errors.imageFile" class="mage-error" id="image_filename-error">
                        <?= $block->escapeHtml(__('This is a required field.')) ?>
                    </div>
                </div>
            </div>

            <div class="field instagram">
                <label class="label" for="instagram">
                    <span><?= $block->escapeHtml(__('Instagram Handle')) ?></span>
                </label>
                <div class="control">
                    <input type="text"
                           name="instagram"
                           id="instagram"
                           title="<?= $block->escapeHtmlAttr(__('Instagram Handle')) ?>"
                           class="input-text"
                           value=""/>
                </div>
            </div>

            <div class="field product-id required">
                <label class="label" for="product_search">
                    <span><?= $block->escapeHtml(__('Product')) ?></span>
                </label>
                <div class="control">
                    <!-- Hidden field for actual product_id submission -->
                    <input type="hidden"
                           name="product_id"
                           id="product_id"
                           :value="selectedProduct ? selectedProduct.id : ''"
                           ref="productId"/>

                    <!-- Selected Product Display -->
                    <div id="filepond-selected-product" v-show="selectedProduct" class="product-selection">
                        <!-- Product Image -->
                        <img v-show="selectedProduct && selectedProduct.image"
                             :src="selectedProduct ? selectedProduct.image : ''"
                             :alt="selectedProduct ? selectedProduct.name : ''"
                             class="product-selection__image"
                             onerror="this.style.display='none'"/>

                        <!-- Product Name -->
                        <span v-text="selectedProduct ? selectedProduct.name : ''" class="product-selection__name"></span>

                        <!-- Clear Button -->
                        <button type="button"
                                @click="clearSelection()"
                                class="product-selection__clear">
                            Clear
                        </button>
                    </div>

                    <!-- Search Input -->
                    <div v-show="!selectedProduct" class="product-search">
                        <input type="text"
                               v-model="searchQuery"
                               @input="debounceSearch"
                               @focus="searchOpen = true"
                               id="product_search"
                               placeholder="<?= $block->escapeHtmlAttr(__('Search for a product...')) ?>"
                               class="input-text"
                               autocomplete="off"/>

                        <!-- Loading Spinner -->
                        <div v-show="searchLoading" class="product-search__loading">
                            <svg class="product-search__spinner" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="product-search__spinner-circle" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                <path class="product-search__spinner-path" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                            </svg>
                        </div>

                        <!-- Dropdown Results -->
                        <div v-show="searchOpen && products.length > 0" class="product-search__dropdown">
                            <div v-for="product in products" :key="product.id"
                                 @click="selectProduct(product)"
                                 class="product-search__item">
                                <!-- Product Image -->
                                <img v-show="product.image"
                                     :src="product.image"
                                     :alt="product.name"
                                     class="product-search__item-image"
                                     onerror="this.style.display='none'"/>
                                <div v-cloak v-show="!product.image" class="product-search__item-placeholder">
                                    <svg class="product-search__item-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path>
                                    </svg>
                                </div>
                                <!-- Product Name -->
                                <span v-text="product.name" class="product-search__item-name"></span>
                            </div>
                        </div>

                        <!-- No Results Message -->
                        <div v-show="searchOpen && !searchLoading && searchQuery.length >= 3 && products.length === 0"
                             class="product-search__no-results">
                            <?= $block->escapeHtml(__('No products found')) ?>
                        </div>
                    </div>

                    <!-- Validation Error Message -->
                    <div v-show="errors.productId" class="mage-error" id="product_id-error">
                        <?= $block->escapeHtml(__('This is a required field.')) ?>
                    </div>
                </div>
            </div>
        </fieldset>

        <div class="actions-toolbar">
            <div class="primary">
                <button type="submit"
                        :disabled="errors.imageFile || errors.customerName || errors.productId"
                        title="<?= $block->escapeHtmlAttr(__('Upload Photo')) ?>"
                        class="action submit primary">
                    <span><?= $block->escapeHtml(__('Upload Photo')) ?></span>
                </button>
            </div>
        </div>
    </form>
</div>
<script type="text/javascript">
    require([
        'jquery',
        'vue',
        'DreamSites_CustomerPhotos/js/FilePondUploaderWrapper',
        'domReady!'
    ], function($, Vue, FilePondUploaderComponent) {

        const { createApp } = Vue;

        const app = createApp({
            data() {
                return {
                    postUrl: <?= json_encode($block->getUploadUrl()) ?>,
                    productSearchUrl: <?= json_encode($block->getProductSearchUrl()) ?>,
                    errors: {
                        customerName: false,
                        imageFile: true, // Initially true until file is uploaded
                        productId: false
                    },
                    searchQuery: '',
                    products: [],
                    selectedProduct: null,
                    searchOpen: false,
                    searchLoading: false,
                    searchDebounceTimer: null,
                    hasImageFile: false
                }
            },
            methods: {
                validateCustomerName(event) {
                    const value = event.target.value.trim();
                    if (value.length === 0) {
                        this.errors.customerName = true;
                    } else if (value.length >= 1) {
                        this.errors.customerName = false;
                    }
                },

                handleFilesProcessed() {
                    // Called when FilePond finishes processing files
                    this.hasImageFile = true;
                    this.errors.imageFile = false;
                },

                debounceSearch() {
                    // Clear existing timer
                    if (this.searchDebounceTimer) {
                        clearTimeout(this.searchDebounceTimer);
                    }

                    // Set new timer
                    this.searchDebounceTimer = setTimeout(() => {
                        this.searchProducts();
                    }, 500);
                },

                searchProducts() {
                    if (this.searchQuery.length < 3) {
                        this.products = [];
                        this.searchOpen = false;
                        return;
                    }

                    this.searchLoading = true;
                    this.searchOpen = true;

                    fetch(this.productSearchUrl + '?q=' + encodeURIComponent(this.searchQuery), {
                        method: 'GET',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-Requested-With': 'XMLHttpRequest'
                        }
                    })
                    .then(r => r.json())
                    .then(data => {
                        this.searchLoading = false;
                        this.products = data.success ? data.products : [];
                    })
                    .catch(err => {
                        console.error('Error searching products:', err);
                        this.searchLoading = false;
                        this.products = [];
                    });
                },

                selectProduct(product) {
                    this.selectedProduct = product;
                    this.searchQuery = '';
                    this.products = [];
                    this.searchOpen = false;
                    this.errors.productId = false;
                },

                clearSelection() {
                    this.selectedProduct = null;
                    this.searchQuery = '';
                    this.products = [];
                    this.searchOpen = false;
                    this.errors.productId = true;
                },

                validateForm(event) {
                    // Reset all errors
                    this.errors.customerName = false;
                    this.errors.imageFile = false;
                    this.errors.productId = false;

                    let hasErrors = false;
                    let firstErrorElement = null;

                    // Validate customer name
                    const customerName = this.$refs.customerName;
                    if (!customerName || !customerName.value.trim()) {
                        this.errors.customerName = true;
                        hasErrors = true;
                        if (!firstErrorElement) firstErrorElement = customerName;
                    }

                    // Validate image file
                    if (!this.hasImageFile) {
                        this.errors.imageFile = true;
                        hasErrors = true;
                        const imageFileInput = document.getElementById('image_filename');
                        if (!firstErrorElement) firstErrorElement = imageFileInput;
                    }

                    // Validate product selection
                    const productId = this.$refs.productId;
                    if (!productId || !productId.value) {
                        this.errors.productId = true;
                        hasErrors = true;
                        if (!firstErrorElement) firstErrorElement = productId;
                    }

                    // If there are errors, prevent submission and scroll to first error
                    if (hasErrors) {
                        event.preventDefault();
                        if (firstErrorElement) {
                            firstErrorElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        return false;
                    }

                    // Form is valid, allow submission
                    return true;
                }
            },
            mounted() {
                // Close dropdown when clicking outside
                document.addEventListener('click', (event) => {
                    const searchContainer = this.$el.querySelector('.product-search');
                    if (searchContainer && !searchContainer.contains(event.target)) {
                        this.searchOpen = false;
                    }
                });
            },
            components: {
                'file-pond-uploader': FilePondUploaderComponent
            },
        });

        app.mount('.customer-photo-form');
    });
</script>
<link rel="stylesheet" href="<?= $block->getViewFileUrl('DreamSites_CustomerPhotos::css/filepond/filepond.min.css') ?>">
<link rel="stylesheet" href="<?= $block->getViewFileUrl('DreamSites_CustomerPhotos::css/filepond/filepond-plugin-image-preview.min.css') ?>">
<link rel="stylesheet" href="<?= $block->getViewFileUrl('DreamSites_CustomerPhotos::css/upload.css') ?>">
